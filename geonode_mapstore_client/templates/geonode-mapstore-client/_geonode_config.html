{% load client_lib_tags %}
{% load base_tags %}
{% load get_menu_json %}
{% comment %}
    app and map configuration need to be normalized
{% endcomment %}

{% comment %} setting.py variables {% endcomment %}
{{ DEFAULT_MAP_CENTER_X|json_script:"settings-DEFAULT_MAP_CENTER_X" }}
{{ DEFAULT_MAP_CENTER_Y|json_script:"settings-DEFAULT_MAP_CENTER_Y" }}
{{ DEFAULT_MAP_CENTER_CRS|json_script:"settings-DEFAULT_MAP_CENTER_CRS" }}
{{ DEFAULT_MAP_ZOOM|json_script:"settings-DEFAULT_MAP_ZOOM" }}
{{ DEFAULT_MAP_CRS|json_script:"settings-DEFAULT_MAP_CRS" }}
{{ DEFAULT_TILE_SIZE|json_script:"settings-DEFAULT_TILE_SIZE" }}
{{ DEFAULT_LAYER_FORMAT|json_script:"settings-DEFAULT_LAYER_FORMAT" }}
{{ MAPSTORE_BASELAYERS|json_script:"settings-MAPSTORE_BASELAYERS" }}
{{ MAPSTORE_BASELAYERS_SOURCES|json_script:"settings-MAPSTORE_BASELAYERS_SOURCES" }}

{{ CATALOGUE_SERVICES|json_script:"settings-CATALOGUE_SERVICES" }}
{{ CATALOGUE_SELECTED_SERVICE|json_script:"settings-CATALOGUE_SELECTED_SERVICE" }}

{% comment %} menu items {% endcomment %}

{% get_menu_json 'CARDS_MENU' as CARDS_MENU %}
{{ CARDS_MENU|json_script:"menu-CARDS_MENU" }}

<script>
    {% autoescape off %}
    (function(){

        function getJSONScriptVariable(id, fallback) {
            const node = document.getElementById(id);
            return node && JSON.parse(node.textContent) || fallback;
        }

        localStorage.setItem('showPopoverSync', false);

        const username = '{{ user|default:"" }}' || null;
        const token = '{{ access_token|default:"" }}' || '{{ ACCESS_TOKEN|default:"" }}' || null;

        const cardsMenuItems = getJSONScriptVariable('menu-CARDS_MENU', []);
        const baseLayers = getJSONScriptVariable('settings-MAPSTORE_BASELAYERS', []);
        const baseLayersSources = getJSONScriptVariable('settings-MAPSTORE_BASELAYERS_SOURCES', {});
        const defaultMapCenterX = getJSONScriptVariable('settings-DEFAULT_MAP_CENTER_X', 0);
        const defaultMapCenterY = getJSONScriptVariable('settings-DEFAULT_MAP_CENTER_Y', 0);
        const defaultMapCenterCRS = getJSONScriptVariable('settings-DEFAULT_MAP_CENTER_CRS', 'EPSG:4326');
        const defaultMapCRS = getJSONScriptVariable('settings-DEFAULT_MAP_CRS', 'EPSG:3857');
        const defaultMapZoom = getJSONScriptVariable('settings-DEFAULT_MAP_ZOOM', 0);
        const defaultTileSize = getJSONScriptVariable('settings-DEFAULT_TILE_SIZE', 512);
        const defaultLayerFormat = getJSONScriptVariable('settings-DEFAULT_LAYER_FORMAT', 'image/png');
        const catalogueServices = getJSONScriptVariable('settings-CATALOGUE_SERVICES', {});
        const catalogueSelectedService = getJSONScriptVariable('settings-CATALOGUE_SELECTED_SERVICE', '');

        window.__GEONODE_CONFIG__ = {
            languageCode: '{{ LANGUAGE_CODE }}',
            resourceId: '{{ resource.pk|default:"" }}',
            resourceType: '{{ resource.resource_type|default:"" }}',
            isNewResource: {{ is_new_resource|default:'false'|safe }},
            isEmbed: {{ is_embed|default:'false'|safe }},
            perms: {{ perms_list|default:'[]' }},
            pluginsConfigKey: '{{ plugins_config_key|default:"" }}',
            userDetails: username && token && {
                user: {
                    name: username
                },
                token: token
            },
            localConfig: {
                proxyUrl: {
                    url: '{{ PROXY_URL|default:"/proxy/?url=" }}',
                    useCORS: []
                },
                printUrl: '{{ GEOSERVER_PUBLIC_LOCATION }}pdf/info.json',
                bingApiKey: '{% bing_api_key %}',
                geoNodeApi: {
                    endpointV1: '{{ SITEURL }}api',
                    endpointV2: '{{ SITEURL }}api/v2'
                },
                // the properties inside geoNodeSettings are stored in the state
                // and accessible by the monitored state with state('settings')
                geoNodeSettings: {
                    catalogueSelectedService: catalogueSelectedService,
                    catalogueServices: catalogueServices,
                    geonodeUrl: '{{ SITEURL }}',
                    geoserverUrl: '{{ OGC_SERVER.default.PUBLIC_LOCATION|default:"" }}',
                    siteName: '{{ SITE_NAME|default:"Geonode" }}',
                    defaultTileSize: defaultTileSize,
                    defaultLayerFormat: defaultLayerFormat
                },
                geoNodeConfiguration: {
                    cardsMenu: {
                        items: cardsMenuItems
                    }
                }
            }, 
        };

        

        // override maps configuration with properties from setting.py
        window.overrideNewMapConfig = function(config) {
            if (config && config.map && config.map.layers) {
                config.map.layers.push(...baseLayers);
            }
            config.map.sources = baseLayersSources;
            config.map.projection = defaultMapCRS;
            config.map.center = {
                x: defaultMapCenterX,
                y: defaultMapCenterY,
                crs: defaultMapCenterCRS
            };
            config.map.zoom = defaultMapZoom;

            config.catalogServices = config.catalogServices || { services: {} };
            if (catalogueServices) {
                config.catalogServices.services = Object.assign(config.catalogServices.services || {}, catalogueServices);
            }
            if (catalogueSelectedService) {
                config.catalogServices.selectedService = catalogueSelectedService;
            }
            return config;
        };

        // override new geostory configuration
        // window.overrideNewGeoStoryConfig = function(config) { return config; };

    })();
    {% endautoescape %}
</script>
{% block override_local_config %}
{% comment %}
<script>
    window.__GEONODE_CONFIG__.overrideLocalConfig = function(localConfig, _) {
        /*
        _ is a subset of lodash and contains following functions
        {
            mergeWith,
            merge,
            isArray,
            isString,
            isObject,
            castArray,
            get
        }
        */
        return _.mergeWith(localConfig, {
            // ...my override config
        }, function(objValue, srcValue, key) {
            if (_.isArray(objValue)) {
                return srcValue;
            }
            // supportedLocales is an object so it's merged with the default one
            // so to remove the default languages we should take only the supportedLocales from override
            if (key === 'supportedLocales') {
                return srcValue;
            }
        });
    };
</script>
{% endcomment %}
{% endblock %}
